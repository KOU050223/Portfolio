name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’ç¢ºèª

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate package.json and package-lock.json
      run: |
        echo "ğŸ” Validating package files..."
        npm audit --audit-level=moderate
        echo "âœ… Package validation completed!"

    - name: Run linting
      run: |
        echo "ğŸ” Running ESLint on changed files..."
        npm run lint
        echo "âœ… Linting passed!"

    - name: Type checking
      run: |
        echo "ğŸ” Running TypeScript type check..."
        npx tsc --noEmit
        echo "âœ… Type check passed!"

    - name: Build test
      run: |
        echo "ğŸ—ï¸ Testing build process..."
        npm run build
        echo "âœ… Build test completed successfully!"

    - name: Check build output
      run: |
        echo "ğŸ“ Checking build output structure..."
        if [ -d ".next" ]; then
          echo "âœ… .next directory created"
          echo "ğŸ“Š Build size: $(du -sh .next | cut -f1)"
        else
          echo "âŒ .next directory not found"
          exit 1
        fi

    - name: Analyze bundle size
      run: |
        echo "ğŸ“Š Bundle Analysis:"
        echo "==================="
        find .next -name "*.js" -type f -exec ls -lh {} \; | head -10
        echo "==================="

    - name: Comment PR with build status
      uses: actions/github-script@v8
      if: always()
      continue-on-error: true
      with:
        script: |
          const status = '${{ job.status }}';
          const emoji = status === 'success' ? 'âœ…' : 'âŒ';
          const message = `${emoji} **PR Build Check ${status.toUpperCase()}**
          
          - Linting: ${status === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
          - Type Check: ${status === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
          - Build Test: ${status === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
          
          Build completed at: ${new Date().toISOString()}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=high
        echo "âœ… Security audit completed!"

    - name: Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        if find . -name "*.env*" -not -path "./node_modules/*" -not -name ".env.example" | grep -q .; then
          echo "âš ï¸ Warning: Environment files detected"
          find . -name "*.env*" -not -path "./node_modules/*" -not -name ".env.example"
        else
          echo "âœ… No sensitive files detected"
        fi